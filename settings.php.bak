<?php
include 'header.php';
$settings = parse_ini_file('settings.ini', true);
?>
<table>
<form action="settings.php" method="post">
<input type="hidden" name="type" value="set-config"/>
<tr>
	<td>key:</td>
	<td><input type="text" name="base[key]" value=""/></td>
</tr>
<tr>
	<td>secret:</td>
	<td><input type="text" name="base[secret]" value=""/></td>
<tr>
	<td>hostname:</td>
	<td><input type="text" name="base[hostname]" value=""/></td>
</tr>
<tr>
	<td>port:</td>
	<td><input type="text" name="base[port]" value=""/></td>
</tr>
<tr>
	<td></td>
	<td><input type="submit" value="添加"/></td>
</tr>
</form>
</table>


<table>
<form action="settings.php" method="post">
<input type="hidden" name="type" value="choice-config">
<?php foreach($settings as $key => $value) { ?>
<tr>
	<td><?php echo $key.' : '.$settings[$key]['hostname'].' - '.$settings[$key]['key'].' - '.$settings[$key]['port'];?></td>
	<td><input type="radio" name="config" value="<?php echo $key;?>"/></td>
</tr>
<?php } ?>
<tr>
	<td></td>
	<td><input type="submit" value="选中" /></td>
</tr>
</form>
</table>

<?php
echo '<pre>';
var_dump($_POST);

$base = @$_POST['base'];
if ($base and $_POST['type'] == 'set-config'){
	set_base($base, $settings);
}else if (@$_POST['config'] and $_POST['type'] == 'choice-config'){
	$basename = $_POST['config'];
	$base_config = $settings[$basename];
	$base_config = convert_array_to_ini(['base'=>$base_config]);
	unset($settings['base']);
	$config = convert_array_to_ini($settings);
	echo $base_config.$config;
	file_put_contents('settings.ini', $base_config.$config);
}

function set_base($base, $settings){
	$new_config = "[base".time()."]\n";
	foreach($base as $key => $value){
		$new_config .= $key.' = '.$value."\n";
	}
	// unset($settings['base']);
	$config = convert_array_to_ini($settings);
	echo $config.$new_config;
	file_put_contents('settings.ini', $new_config.$config);
}


function convert_array_to_ini($settings){
	foreach($settings as $key => $value){
		$config = "[".$key."]\n";
		foreach($value as $k => $v){
			$config .= $k .' = '.$v."\n";
		}
	}
	return $config;
}















